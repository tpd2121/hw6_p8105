hw6_p8105
================
2024-11-29

## Problem 2

**2A. Data export and cleaning**

``` r
homicide = read.csv("./data/homicide-data.csv") %>% 
  unite(city_state, c(city, state), sep = ", ") %>% 
  mutate(
    disposition = str_replace(disposition, "Closed by arrest", "Solved"), 
    disposition = str_replace(disposition, "Closed without arrest", "Unsolved"), 
    disposition = str_replace(disposition, "Open/No arrest", "Unsolved"), 
    disposition_binary = ifelse(disposition == "Solved", 1, 0),
    victim_age = as.numeric(victim_age)
  ) %>% 
  filter(!(city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"))) %>%
  filter(victim_race %in% c("White", "Black")) %>% 
  filter(victim_sex %in% c("Female", "Male")) %>% 
  select(city_state, victim_race, victim_age, victim_sex, disposition_binary) %>% 
  drop_na()
```

**2B. Baltimore, MD**

``` r
baltimore_glm = homicide %>% 
  filter(city_state == "Baltimore, MD") %>%  
  glm(disposition_binary ~ victim_age + victim_race + victim_sex, family = binomial(), data = .)

tidy_baltimore = broom::tidy(baltimore_glm)

CI = confint(baltimore_glm) %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "term") %>%
  rename("conf_low" = "2.5 %", "conf_high" = "97.5 %")
  
baltimore_data = left_join(tidy_baltimore, CI, by = "term") %>% 
  mutate(
    OR = exp(estimate),
    conf_low2 = exp(conf_low), 
    conf_high2 = exp(conf_high)
    ) %>% 
  rename("log_OR" = "estimate") %>% 
  select(term, OR, conf_low2, conf_high2) %>% 
  filter(term == "victim_sexMale")
  
knitr::kable(baltimore_data)
```

| term           |        OR | conf_low2 | conf_high2 |
|:---------------|----------:|----------:|-----------:|
| victim_sexMale | 0.4255117 | 0.3241908 |  0.5575508 |

``` r
#can't use knitr in piping
```

**2C. All cities**

``` r
homicide_function = function(df) {
  glm_result = glm(disposition_binary ~ victim_age + victim_race + victim_sex, family = binomial(), data = df)
}

homicide_glm = homicide %>% 
  group_by(city_state) %>% 
  nest() %>%   
  mutate(
    glm_result = map(data, homicide_function), 
    tidy_result = map(glm_result, broom::tidy), 
    confint_result = map(glm_result, ~ as.data.frame(confint(.x)))
  ) %>% 
  mutate(
    stat_result = map2(tidy_result, confint_result, ~ {
      tidy_df <- .x 
      ci <- .y 
      colnames(ci) <- c("conf_low", "conf_high") 
      ci$term <- rownames(ci)
      left_join(tidy_df, ci, by = "term")
    })
  )
  
#cannot put CI as part of the homicide function, as glm_data will end up being CI result instead of glm result
#do separate mutate functions
#how to extract the confint result?

homicide_stat = homicide_glm %>% 
  select(city_state, stat_result) %>% 
  unnest(stat_result) %>% 
  mutate(
    OR = exp(estimate),
    conf_low2 = exp(conf_low), 
    conf_high2 = exp(conf_high),
    city_state = as.factor(city_state)
    ) %>% 
  rename("log_OR" = "estimate") %>% 
  filter(term == "victim_sexMale") %>% 
  select(city_state, OR, conf_low2, conf_high2)

knitr::kable(homicide_stat)
```

| city_state         |        OR | conf_low2 | conf_high2 |
|:-------------------|----------:|----------:|-----------:|
| Albuquerque, NM    | 1.7674995 | 0.8247082 |  3.7618597 |
| Atlanta, GA        | 1.0000771 | 0.6803477 |  1.4582575 |
| Baltimore, MD      | 0.4255117 | 0.3241908 |  0.5575508 |
| Baton Rouge, LA    | 0.3814393 | 0.2043481 |  0.6836343 |
| Birmingham, AL     | 0.8700153 | 0.5713814 |  1.3138409 |
| Boston, MA         | 0.6673219 | 0.3508461 |  1.2600381 |
| Buffalo, NY        | 0.5205704 | 0.2884416 |  0.9358300 |
| Charlotte, NC      | 0.8838976 | 0.5507440 |  1.3905954 |
| Chicago, IL        | 0.4100982 | 0.3361233 |  0.5008546 |
| Cincinnati, OH     | 0.3998277 | 0.2313767 |  0.6670456 |
| Columbus, OH       | 0.5324845 | 0.3770457 |  0.7479124 |
| Denver, CO         | 0.4790620 | 0.2327380 |  0.9624974 |
| Detroit, MI        | 0.5823472 | 0.4619454 |  0.7335458 |
| Durham, NC         | 0.8123514 | 0.3824420 |  1.6580169 |
| Fort Worth, TX     | 0.6689803 | 0.3935128 |  1.1211603 |
| Fresno, CA         | 1.3351647 | 0.5672553 |  3.0475080 |
| Houston, TX        | 0.7110264 | 0.5569844 |  0.9057376 |
| Indianapolis, IN   | 0.9187284 | 0.6784616 |  1.2413059 |
| Jacksonville, FL   | 0.7198144 | 0.5359236 |  0.9650986 |
| Las Vegas, NV      | 0.8373078 | 0.6058830 |  1.1510854 |
| Long Beach, CA     | 0.4102163 | 0.1427304 |  1.0241775 |
| Los Angeles, CA    | 0.6618816 | 0.4565014 |  0.9541036 |
| Louisville, KY     | 0.4905546 | 0.3014879 |  0.7836391 |
| Memphis, TN        | 0.7232194 | 0.5261210 |  0.9835973 |
| Miami, FL          | 0.5152379 | 0.3040214 |  0.8734480 |
| Milwaukee, wI      | 0.7271327 | 0.4951325 |  1.0542297 |
| Minneapolis, MN    | 0.9469587 | 0.4759016 |  1.8809745 |
| Nashville, TN      | 1.0342379 | 0.6807452 |  1.5559966 |
| New Orleans, LA    | 0.5849373 | 0.4218807 |  0.8121787 |
| New York, NY       | 0.2623978 | 0.1327512 |  0.4850117 |
| Oakland, CA        | 0.5630819 | 0.3637421 |  0.8671086 |
| Oklahoma City, OK  | 0.9740747 | 0.6228507 |  1.5199721 |
| Omaha, NE          | 0.3824861 | 0.1988357 |  0.7109316 |
| Philadelphia, PA   | 0.4962756 | 0.3760120 |  0.6498797 |
| Pittsburgh, PA     | 0.4307528 | 0.2626022 |  0.6955516 |
| Richmond, VA       | 1.0060520 | 0.4834671 |  1.9936248 |
| San Antonio, TX    | 0.7046200 | 0.3928179 |  1.2382509 |
| Sacramento, CA     | 0.6688418 | 0.3262733 |  1.3143887 |
| Savannah, GA       | 0.8669817 | 0.4185827 |  1.7802453 |
| San Bernardino, CA | 0.5003444 | 0.1655367 |  1.4623977 |
| San Diego, CA      | 0.4130248 | 0.1913527 |  0.8301847 |
| San Francisco, CA  | 0.6075362 | 0.3116925 |  1.1551470 |
| St. Louis, MO      | 0.7031665 | 0.5298505 |  0.9319005 |
| Stockton, CA       | 1.3517273 | 0.6256427 |  2.9941299 |
| Tampa, FL          | 0.8077029 | 0.3395253 |  1.8598834 |
| Tulsa, OK          | 0.9757694 | 0.6090664 |  1.5439356 |
| Washington, DC     | 0.6910490 | 0.4659731 |  1.0135014 |

**2D. Plotting homicide stat**

``` r
homicide_stat = homicide_stat %>% 
  arrange(OR) %>% 
  mutate(city_state = fct_reorder(city_state, OR))

ggplot(homicide_stat, aes(x = OR, y = city_state)) + 
    geom_point() +
    geom_errorbar(aes(xmin = conf_low2, xmax = conf_high2))
```

![](hw6_p8105_files/figure-gfm/homicide%20plot-1.png)<!-- -->

``` r
#need to exp the CI too otherwise the OR falls outside of the CI range (bc the CI was still the original CI log)
#fct_reorder not working
```

Comment on the plot

## Problem 3

3a. Load and clean the data for regression analysis (i.e. convert
numeric to factor where appropriate, check for missing data, etc.).

``` r
birthweight_masterdata = homicide = read.csv("./data/birthweight.csv") %>% 
  mutate(
    babysex = as.factor(babysex),
    malform = as.factor(malform)
  ) %>% 
  drop_na()

#ggplot(birthweight_masterdata, aes(x=wtgain)) +
  #geom_histogram()
#fincome, momage, race,  parity, pnumlbw, pnumsga, smoken are all non-normal distribution
```

3b. Propose a regression model for birthweight. This model may be based
on a hypothesized structure for the factors that underly birthweight, on
a data-driven model-building process, or a combination of the two.
Describe your modeling process and show a plot of model residuals
against fitted values – use add_predictions and add_residuals in making
this plot.

3c. Compare your model to two others:

- One using length at birth and gestational age as predictors (main
  effects only)
- One using head circumference, length, sex, and all interactions
  (including the three-way interaction) between these

Make this comparison in terms of the cross-validated prediction error;
use crossv_mc and functions in purrr as appropriate.
